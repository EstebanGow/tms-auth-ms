name: Main Flow
on:
    push:
        branches:
            - 'main'

env:
    SERVICE_NAME: tms-auth-ms
    PROJECT_ID: ${{ secrets.PROJECT_ID }}
    REGION: us-central1
    ENV_FILE: env/main.env
    ENV: dev
    HOST: localhost
    MEMORY: 512Mi
    CPU: 1
    ALLOW_UNAUTHENTICATED: true
    DOMAIN: tms
    SUB_DOMAIN: example
jobs:
    build_and_deploy:
        runs-on: ubuntu-latest
        name: Build and deploy
        outputs:
            url: ${{ steps.extract_url.outputs.url }}
            branch: ${{ steps.extract_branch.outputs.branch }}
        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - name: Extract branch name
              shell: bash
              run: echo "branch=$(echo ${GITHUB_REF#refs/heads/})" >> $GITHUB_OUTPUT
              id: extract_branch
            - name: Set branch-based environment variables
              uses: iamtheyammer/branch-env-vars@v1.0.3
              with:
                  GCP_PROJECT: |
                      main:${{ secrets.PROJECT_ID }}
                     
                  ENV_FILE: |
                      main:ENV_PROD
            - name: Cache node modules
              uses: actions/cache@v3
              with:
                  path: '**/node_modules'
                  key: ${{ runner.os }}-modules-${{ hashFiles('**/yarn.lock') }}
            - name: Install and Build
              uses: ./.github/actions/build
            - name: Build tests
              uses: ./.github/actions/quality
            - name: Create ENV File
              run: |
                mkdir -p env
                echo "PROJECT_ID=${{ env.PROJECT_ID }}" >> ${{ env.ENV_FILE }}
                echo "SERVICE_NAME=${{ env.SERVICE_NAME }}" >> ${{ env.ENV_FILE }}
                echo "HOST=${{ env.HOST }}" >> ${{ env.ENV_FILE }}
                echo "DOMAIN=${{ env.DOMAIN }}" >> ${{ env.ENV_FILE }}
                echo "POSTGRES_HOST=${{ secrets.POSTGRES_HOST }}" >> ${{ env.ENV_FILE }}
                echo "ENV=dev" >> ${{ env.ENV_FILE }}
                echo "PG_PORT=${{ secrets.PG_PORT }}" >> ${{ env.ENV_FILE }}
                echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> ${{ env.ENV_FILE }}
                echo "POSTGRES_PASS=${{ secrets.POSTGRES_PASS }}" >> ${{ env.ENV_FILE }}
                echo "POSTGRES_DATABASE=${{ secrets.POSTGRES_DATABASE }}" >> ${{ env.ENV_FILE }}
                echo "PORT=8080" >> ${{ env.ENV_FILE }}
                echo "PREFIX_LOGGER=cm" >> ${{ env.ENV_FILE }}
                echo "LOGGER_LEVEL=debug" >> ${{ env.ENV_FILE }}
                echo "VERSION=v1" >> ${{ env.ENV_FILE }}
                echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ${{ env.ENV_FILE }}
                cp ${{ env.ENV_FILE }} .env
            - name: Set up Cloud SDK
              uses: google-github-actions/setup-gcloud@master
              with:
                  project_id: ${{ env.GCP_PROJECT }}
                  service_account_key: ${{ secrets.GCP_SA_KEY }}
                  export_default_credentials: true
            - name: Build and deploy image
              run: PROJECT_ID=$GCP_PROJECT COMMIT_SHA=${{ github.sha }} SERVICE_NAME=$SERVICE_NAME make deploy
            - name: Deploy to Cloud Run
              run: |-
                  gcloud run deploy yohan-$SERVICE_NAME \
                    --image gcr.io/$GCP_PROJECT/yohan-$SERVICE_NAME:${{ github.sha }} \
                    --allow-unauthenticated \
                    --region $REGION \
                    --max-instances 2
            - name: Get URL Cloud Run
              shell: bash
              run: echo "url=$(gcloud run services describe $SERVICE_NAME --platform managed --region $REGION --format 'value(status.url)')" >> $GITHUB_OUTPUT
              id: extract_url